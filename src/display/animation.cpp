#include "display/animation.h"
#include <Arduino.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <string.h> // Nécessaire pour strlen

// Bitmap logo ECE (128x64)
const unsigned char logoECE[] PROGMEM = {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x0f, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x7f, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x01, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x07, 0xff, 0xfc, 0x00, 0x7f, 0xff, 0xf0, 0x00, 0x7f, 0xe0, 0x07, 0xff, 0xff, 0x80, 
0x00, 0x00, 0x1f, 0xff, 0xfe, 0x00, 0x7f, 0xff, 0xf8, 0x01, 0xff, 0xf8, 0x07, 0xff, 0xff, 0x80, 
0x00, 0x00, 0x3f, 0xff, 0x3e, 0x00, 0x7f, 0xff, 0xf8, 0x07, 0xff, 0xfe, 0x07, 0xff, 0xff, 0x80, 
0x00, 0x00, 0xff, 0xf0, 0x06, 0x00, 0x7f, 0xff, 0xf8, 0x0f, 0xff, 0xff, 0x07, 0xff, 0xff, 0x80, 
0x00, 0x01, 0xff, 0xc0, 0x06, 0x00, 0x70, 0x00, 0x00, 0x1f, 0xc0, 0x3f, 0x87, 0x00, 0x00, 0x00, 
0x00, 0x03, 0xff, 0x00, 0x02, 0x00, 0x78, 0x00, 0x00, 0x3f, 0x00, 0x0f, 0xc7, 0x80, 0x00, 0x00, 
0x00, 0x07, 0xfe, 0x00, 0x00, 0x00, 0x78, 0x00, 0x00, 0x3e, 0x00, 0x07, 0xc7, 0x80, 0x00, 0x00, 
0x00, 0x0f, 0xfc, 0x00, 0x00, 0x00, 0x78, 0x00, 0x00, 0x7c, 0x00, 0x03, 0x07, 0x80, 0x00, 0x00, 
0x00, 0x1f, 0xf8, 0x00, 0x00, 0x00, 0x78, 0x00, 0x00, 0x7c, 0x00, 0x00, 0x07, 0x80, 0x00, 0x00, 
0x00, 0x3f, 0xe0, 0x00, 0x00, 0x00, 0x78, 0x00, 0x00, 0x78, 0x00, 0x00, 0x07, 0xc0, 0x00, 0x00, 
0x00, 0x7f, 0xe0, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xc0, 0xf8, 0x00, 0x00, 0x07, 0xff, 0xfe, 0x00, 
0x00, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xc0, 0xf8, 0x00, 0x00, 0x07, 0xff, 0xfe, 0x00, 
0x00, 0xff, 0x80, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xc0, 0xf8, 0x00, 0x00, 0x07, 0xff, 0xfe, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xc0, 0xf8, 0x00, 0x00, 0x07, 0xff, 0xfc, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x78, 0x00, 0x00, 0x78, 0x00, 0x00, 0x07, 0x80, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x78, 0x00, 0x00, 0x78, 0x00, 0x00, 0x07, 0x80, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x3f, 0xe0, 0x78, 0x00, 0x00, 0x7c, 0x00, 0x00, 0x07, 0x80, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x7f, 0xc0, 0x78, 0x00, 0x00, 0x3e, 0x00, 0x07, 0x87, 0x80, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0xff, 0xc0, 0x78, 0x00, 0x00, 0x3f, 0x00, 0x0f, 0xc7, 0x80, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x01, 0xff, 0x80, 0x78, 0x00, 0x00, 0x1f, 0xc0, 0x3f, 0x87, 0xc0, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x03, 0xff, 0x00, 0x7f, 0xff, 0xf8, 0x0f, 0xff, 0xff, 0x07, 0xff, 0xff, 0xc0, 
0x00, 0x00, 0x00, 0x07, 0xfe, 0x00, 0x7f, 0xff, 0xf8, 0x07, 0xff, 0xfe, 0x07, 0xff, 0xff, 0xc0, 
0x00, 0x08, 0x00, 0x0f, 0xfc, 0x00, 0x7f, 0xff, 0xf8, 0x01, 0xff, 0xfc, 0x07, 0xff, 0xff, 0xc0, 
0x00, 0x08, 0x00, 0x3f, 0xf8, 0x00, 0x7f, 0xff, 0xf8, 0x00, 0x7f, 0xe0, 0x07, 0xff, 0xff, 0x80, 
0x00, 0x08, 0x00, 0x7f, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x0c, 0x01, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x0f, 0x0f, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x0f, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x0f, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x07, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x03, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

void animationDemarrage(Adafruit_SSD1306 &display) {
    display.clearDisplay();
    display.display();

    // ---- FADE-IN ----
    for (int level = 0; level < 256; level += 16) {
        display.clearDisplay();
        display.drawBitmap(0, 0, logoECE, 128, 64, 1);
        display.dim(level < 128);
        display.display();
        delay(50);
    }

    delay(300);

    // ---- MACHINE À ÉCRIRE ----
    const char* text = "    BIP-BIP ECE";
    String temp = "";
    size_t len = strlen(text);

    for (size_t i = 0; i < len; i++) {
        temp += text[i];

        display.clearDisplay();
        display.drawBitmap(0, 0, logoECE, 128, 64, 1);

        display.setTextSize(1);
        display.setTextColor(WHITE);
        display.setCursor(10, 52);
        display.print(temp);

        display.display();
        delay(35);
    }

    delay(200);

    // ---- FADE-OUT ----
    for (int level = 255; level >= 0; level -= 16) {
        display.clearDisplay();
        display.drawBitmap(0, 0, logoECE, 128, 64, 1);
        display.dim(level < 128);
        display.display();
        delay(30);
    }

    // CORRECTION DE SÉCURITÉ : Assure la luminosité maximale après l'animation
    display.dim(false); 
    
    display.clearDisplay();
    display.display();
}